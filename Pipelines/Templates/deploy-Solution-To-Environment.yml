stages:
- stage: deploy
  displayName: 'Deploy to Environment'
  jobs:
  - deployment: 
    condition: and(succeeded(), ne(variables['Build.SourceBranchName'], variables['ProductionSourceBranch']), ne(variables['System.PullRequest.TargetBranch'], variables['ProductionSourceBranch']))
    pool: 
      vmImage: 'windows-2019'
    variables: # The build contains an output variable named TriggerSolutionUpgrade that is used in the deployment steps to determine whether to perform a solution upgrade or update
      TriggerSolutionUpgrade: false
    environment: '$(EnvironmentName)'
    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              echo 'Environment Name: $(EnvironmentName)'
              echo 'Valid Value: ${{parameters.deploymentValidForEnvironment}}'
              echo 'PR Branch: $(System.PullRequest.TargetBranch)'
              echo 'Build Source Branch: $(Build.SourceBranchName)'
              echo 'Prod Source: $(ProductionSourceBranch)'

          - template: deploy-Solution.yml
            parameters:
              serviceConnection: '$(ServiceConnection)'
              environmentVariables: '$(EnvironmentVariables)'
              connectionReferences: '$(ConnectionReferences)'
              aadGroupTeamConfiguration: '$(AadGroupTeamConfiguration)'
              aadGroupCanvasConfiguration: '$(AadGroupCanvasConfiguration)'
              solutionComponentOwnershipConfiguration: '$(SolutionComponentOwnershipConfiguration)'
